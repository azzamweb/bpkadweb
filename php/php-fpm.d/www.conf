; PHP-FPM Pool Configuration for WordPress
; Optimized for 4GB RAM server
;
; TUNING FORMULA:
; pm.max_children = (Available RAM - other services) / avg_process_size
; For 4GB server: (4096MB - 1536MB for OS/DB/Nginx) / 50MB per PHP process = ~50
;
; Different RAM sizes:
; 2GB: max_children=25, start_servers=5, min_spare=3, max_spare=8
; 8GB: max_children=100, start_servers=20, min_spare=10, max_spare=30
; 16GB: max_children=200, start_servers=40, min_spare=20, max_spare=60

[www]

; Pool user and group
user = www-data
group = www-data

; The address on which to accept FastCGI requests
listen = 9000

; Set listen(2) backlog
listen.backlog = 511

; Set permissions for unix socket (not used in this config)
;listen.owner = www-data
;listen.group = www-data
;listen.mode = 0660

; List of addresses (IPv4/IPv6) of FastCGI clients which are allowed to connect
; Note: Commented out to allow all connections within Docker network
; listen.allowed_clients = 127.0.0.1

; Choose how the process manager will control the number of child processes
; Options: static, dynamic, ondemand
; - static: fixed number of children
; - dynamic: dynamically adjust based on load (recommended for production)
; - ondemand: spawn children on-demand (good for low-traffic sites)
pm = dynamic

; Maximum number of child processes
; For 4GB RAM: 50 children Ã— 50MB = 2.5GB max
pm.max_children = 50

; Number of child processes created on startup
; Recommended: 20-25% of max_children
pm.start_servers = 10

; Desired minimum number of idle server processes
; Recommended: 10-20% of max_children
pm.min_spare_servers = 5

; Desired maximum number of idle server processes
; Recommended: 25-35% of max_children
pm.max_spare_servers = 15

; Number of requests each child should process before respawning
; Helps prevent memory leaks
pm.max_requests = 500

; Time limit for processing a single request
request_terminate_timeout = 300s

; Slow request log
request_slowlog_timeout = 10s
slowlog = /var/log/php-fpm/slow.log

; Process management
; The number of seconds to wait before force-killing child
; Note: process_control_timeout removed - not supported in all PHP-FPM versions

; The ping URI to call the monitoring page of FPM
ping.path = /ping
ping.response = pong

; The access log file
access.log = /var/log/php-fpm/access.log

; The access log format
access.format = "%R - %u %t \"%m %r%Q%q\" %s %f %{mili}d %{kilo}M %C%%"

; Environment variables
env[HOSTNAME] = $HOSTNAME
env[PATH] = /usr/local/bin:/usr/bin:/bin
env[TMP] = /tmp
env[TMPDIR] = /tmp
env[TEMP] = /tmp

; PHP configuration values
; These override php.ini settings for this pool

; Memory limit per request
php_admin_value[memory_limit] = 256M

; Maximum execution time
php_admin_value[max_execution_time] = 300

; Error logging
php_admin_value[error_log] = /var/log/php-fpm/error.log
php_admin_flag[log_errors] = on

; Disable dangerous functions
php_admin_value[disable_functions] = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source

; Session configuration
php_value[session.save_handler] = files
php_value[session.save_path] = /tmp
php_value[session.gc_maxlifetime] = 1440

; Upload limits
php_admin_value[upload_max_filesize] = 64M
php_admin_value[post_max_size] = 64M

; Timezone
php_admin_value[date.timezone] = Asia/Jakarta

; OPcache settings (tuned for WordPress)
php_admin_value[opcache.enable] = 1
php_admin_value[opcache.memory_consumption] = 128
php_admin_value[opcache.interned_strings_buffer] = 16
php_admin_value[opcache.max_accelerated_files] = 10000
php_admin_value[opcache.revalidate_freq] = 2
; Note: opcache.fast_shutdown deprecated in PHP 7.2+, removed
; php_admin_value[opcache.fast_shutdown] = 1

; Performance tuning
php_admin_value[realpath_cache_size] = 4096K
php_admin_value[realpath_cache_ttl] = 600

; Security
php_admin_flag[expose_php] = off
php_admin_flag[allow_url_fopen] = on
php_admin_flag[allow_url_include] = off

; Buffer settings
php_value[output_buffering] = 4096

; APCu (if enabled)
php_admin_value[apc.enabled] = 1
php_admin_value[apc.shm_size] = 32M

; Clear environment on FPM reload
clear_env = no

; Limit extensions that can be parsed
security.limit_extensions = .php

; Status page
pm.status_path = /status

